# Overview

This repository contains scripts to perform quality control (QC), preprocessing 
and imputation of microarray-based genotype data. 

- Step 0: Manual preparation of raw genotype data as Plink bfile set (*.bed, 
*.bim, *.fam) with phenotypic sex info in *.fam
- Step 1: Pre-imputation quality control part 1 - 
[bin/01_run_genotype_QC_part1.sh](bin/01_run_genotype_QC_part1.sh)
- Step 2: Manual preparation of sample exclusions and sample swaps based on 
sample identity issues detected in part 1 (sex mismatches, duplicates)
- Step 3: Pre-imputation quality control part 2 - 
[bin/02_run_genotype_QC_part2.sh](bin/02_run_genotype_QC_part2.sh)
- Step 4: Imputation -> [imputation.nf](imputation.nf)

Note: The scripts represent templates that might need to be modified to suit a 
given dataset / project.


# TODO

- implement named command-line arguments for the pre-imputation QC scripts
(instead of the currently used positional mapping)


# Requirements / Getting Started

*Please note: There have been changes regarding the licensing of Anaconda
(e.g. see https://redresscompliance.com/anaconda-licensing-changes-explained/ or
https://www.theregister.com/2024/08/08/anaconda_puts_the_squeeze_on/)**

```
git clone https://github.com/friedav/Genotyping_Pipeline.git
cd Genotyping_Pipeline
conda env create -f environment.yml -p ./env
```

Tools that need to be manually installed and present in your `$PATH`:
- Nextflow v22.10.x or older (important because script is based on DSL1, which
 is no longer supported by newer Nextflow versions)
- Eagel v2.4.0 (https://alkesgroup.broadinstitute.org/Eagle/)
- Minimac4 (https://github.com/statgen/Minimac4)
- bcftools (http://samtools.github.io/bcftools/)
- GATK4 (https://github.com/broadinstitute/gatk)
- KING (https://www.kingrelatedness.com/Download.shtml) - only for 
pre-imputation QC script 2

Tools that need to be manually installed and paths modified in `imputation.nf`:
- `check_script`: Will Rayner's script for "HRC or 1000G Imputation preparation 
and checking" (https://www.chg.ox.ac.uk/~wrayner/tools/)

Reference data files that need to be manually prepared and paths modified in 
`imputation.nf`:
- reference haplotypes
  - `refvariants`: variant table, e.g. 1000GP_Phase3_combined.legend based on 
  https://www.chg.ox.ac.uk/~wrayner/tools/1000GP_Phase3_combined.legend.gz
  - `refeagle`: chr-level BCF files to be used by Eagle, e.g. see 
  https://alkesgroup.broadinstitute.org/Eagle/#x1-310005.3.1
  - `refminimac`: chr-level MSAV files to be used by Minimac, e.g. from 
  https://share.sph.umich.edu/minimac4/panels/g1k_p3_msav_files_with_estimates.tar.gz
- `dbsnp`: dbSNP variants for annotation of rsIDs, e.g. from 
https://ftp.ncbi.nih.gov/snp/pre_build152/organisms/human_9606_b151_GRCh37p13/VCF/00-All.vcf.gz
- `genmap`: genetic coordinates, e.g. those provided with the Eagel installation 
(Eagle_v2.4.1/tables/genetic_map_hg19_withX.txt.gz)


# Pre-imputation QC

The pre-imputation genotype QC consists of three steps, since in case of the
identification of sex mismatches and genetic duplicates in step 1 you might
want to investigate these issues in step 2 before continuing with step 3 (with
optional sample swapping and removal), instead of simply excluding all samples
with sample identity issues identified in step 1.

Example workflow for the pre-imputation QC for a given raw genotype bfile set
(*.bed, *.bim, *.fam), assuming the following environment variables:

```bash
raw="path/to/raw/bfile/set_withoutFileExtensions"
outpref="output_prefix"
outdir="output/directory"
```
After performing all three steps, the post-QC output bfile set can be found at
`${outdir}/${outpref}_postQC.{bed,bim,fam}`. This bfile set can then be used as
input for genotype imputation.
A summary of sample exclusions is provided in
`${outdir}/${outpref}.sample_exclusions.tsv`


## Step 1

```
# step 1
bin/01_run_genotype_QC_part1.sh $raw $outpref $outdir
```

## Step 2

Look at the files `${outdir}/${outpref}_QC3_sex.sexcheck` and
`${outdir}/${outpref}_QC4_dups.genome` that were generated by step 1 to check
for sex mismatches and genetic duplicates. 
Ideally, go talk to the people that were involved in the sample recruitment,
collection, and handling to figure out what might have happened. Depending on
the outcome of this investigation, you might want to update the phenotypic sex 
information of individual samples and rerun step 1. 
Additionally, two (optional) files can be prepared for step 3 that indicate
samples to be excluded (remove file) and samples to be swapped with a different 
sample (swap file).

**Swap file**: In case any sample swaps have been unambiguously identified, they 
can be resolved in step 3 by updating the sample IDs (or rather the lines in the 
FAM file). 
To do so, a swap file needs to be manually prepared, with two named columns:
- "current" = old sample IID
- "replacement" = new sample IID  

This means, to swap exactly two samples, the swap file needs to contain header +
two rows. It is implemented in this way to allow for triangle swaps, i.e., 
ID1→ID2, ID2→ID3, ID3→ID1. Note: Resolving sample swaps might also resolve some 
sex mismatches.

**Remove file**: For any samples where the identified sex mismatches and/or 
genetic duplicates leave doubts in the sample identity (i.e., if it is unclear 
to which individual a given sample in the genotype dataset actually corresponds 
to), the IID and FID should be added to a remove file (no header needed, should
be a tab-separated plain text file) so that they can be excluded from the
dataset in step 3.


## Step 3

For the QC script of step 3, an array-specific "Illumina variant ID to rs ID"
mapping file needs to be obtained from Illumina and provided as command-line
argument. E.g., for the PsychArray v1.1 this file is named 
"InfiniumPsychArray-24v1-1_A1_b138_rsids.txt".

```
idmap="path/to/the/IlluminaID_to_rsID.file"
remove="path/to/your/step2_remove.file" # optional
swap="path/to/your/step2_swap.file"     # optional

# step 3
bin/02_run_genotype_QC_part2.sh $outpref $outdir $idmap $remove $swap 
```
If no samples should be swapped, the `$swap` argument can be omitted.  
If no samples need to be removed AND no samples should be swapped, both the 
`$remove` and the `$swap` argument can be omitted.  
If no samples need to be removed BUT some samples should be swapped, an empty
file should be used for the `$remove` argument together with the respective
`$swap` argument.




# Imputation

Phasing with Eagle2 and imputation with Minimac4 is implemented in the Nextflow 
script [imputation.nf](imputation.nf).
As reference data, either the 1000 Genomes Phase 3 (`1kg`) or the Haplotype 
Reference Consortium (`HRC`) are intended.

Example command to start Nextflow run:

```bash
nextflow run imputation.nf -resume -with-report \
  --outdir "output" \
  --outpref "example" \
  --bfile_dir "output/from/preimputation_QC_part2" \
  --bfile_pref "example_postQC" \
  --ref "1kg"
```

`outdir` and `outpref` specify the output directory and prefix string for the 
to-be-created output.  
`bfild_dir` and `bfile_pref` specify the directory and prefix of the post-QC 
pre-imputation Plink bfile set to be used as input. This would be 
"\${outdir}/${outpref}_postQC" for the example in the pre-imputation QC section
above.
`ref` should be "1kg" or "HRC" and specifies which reference panel to use. 

